@page "/"
@using System.Linq;
@using Markdig
@using OpenAI_API
@using OpenAI_API.Chat
@inject OpenAIAPI openAIAPI

<PageTitle>My ChatGPT</PageTitle>

<h4>Welcome to my Chat using OpenAI</h4>
@if (warningMessage.Length > 0)
{
    <div class="alert alert-warning">
        <strong>Warning!</strong> @warningMessage.
    </div>
}
<div class="row">
    <EditForm Model=@this>
        @foreach (var chat in conversation.Messages)
        {
            <h5>@chat.Role</h5>
            @((MarkupString)Markdown.ToHtml(chat.Content))
        }

        @if (!string.IsNullOrEmpty(stream))
        {
            <h5>assistant</h5>
            @((MarkupString)Markdown.ToHtml(stream))
        }
        @if (loading)
        {
            <br />
            <div class="loader"></div>
            <p>... please wait ...</p>
        }
        <hr />
        <div class="col-sm-8">
            <InputTextArea type="text" class="form-control" @onkeydown="@OnCtrlEnter" placeholder="CTRL+Enter to submit search" @bind-Value=next @ref=nextArea />
        </div>
        <br />
        <div class="col-sm-2">
            <button class="btn btn-danger" @onclick="OnSearchClick" type="submit" disabled=@loading>
                <i class="fas fa-times"></i>Submit
            </button>
        </div>
    </EditForm>
</div>

@code {
    private Conversation conversation = null!;

    private string warningMessage = "";
    private string next = "";
    private string stream = "";
    private bool loading = true;
    private InputTextArea nextArea = null!;

    protected override void OnInitialized()
    {
        conversation = openAIAPI.Chat.CreateConversation();
        conversation.AppendSystemMessage("You are the assistant of a software engineer mainly working with .NET and Azure.");
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender && nextArea.Element != null){
            loading = false;
            this.StateHasChanged();
            await nextArea.Element.Value.FocusAsync();
        }
    }

    public async void OnSearchClick()
    {
        await RunSearch();
    }
    public async void OnCtrlEnter(KeyboardEventArgs e)
    {
        if (e.Code == "Enter" && e.CtrlKey)
        {
            await RunSearch();
            await nextArea.Element.Value.SelectAsync();
        }
    }

    public async Task RunSearch()
    {
        try
        {
            loading = true;
            this.StateHasChanged();

            conversation.AppendUserInput(next);

            //await conversation.GetResponseFromChatbotAsync();
            await conversation.StreamResponseFromChatbotAsync(x =>
            {
                // We collect response as it comes in and display it immediately
                stream += x;
                this.StateHasChanged();
            });

            // Bug workaround when using StreamResponseFromChatbotAsync - TODO create GitHub issue
            conversation.Messages.Last().Role = ChatMessageRole.Assistant;
            // Now that the message is part of the conversation, we remove our temporary copy
            stream = "";
            loading = false;
            warningMessage = string.Empty;
        }
        catch (Exception ex)
        {
            warningMessage = ex.Message;
        }
        finally
        {
            loading = false;
            this.StateHasChanged();
        }
    }
}